<html>
  <head>
    <title>Wordle Results</title>
    <!-- <link rel="shortcut icon" type="image/png" href="Transact.png"> -->
    <style>
      * {font-family: Arial, sans-serif;
        }
      table, td, th {
        border: 1px solid;
        padding: 10px;
      }
    </style>
    <style>
      .table-container {
      height: 500px;              /* enough for ~10 rows */
      overflow-y: scroll;         /* vertical scrollbar */
      display: block;
      border: 1px solid #ccc;
      margin: auto;
      width: 70%;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
  </head>
  
  <body>
    <div id="everything">
      
      <p align=center style="font-size: 30px;"><strong>This Year's Results</strong></p>
      
      <div class="table-container" id="scrollTable">

      <table style="font-size: 30px; padding: 6px" align=center>
        <thead><tr><th>Date</th></th><th>Word</th><th>Chris</th><th>Julia</th><th>Nick</th></tr></thead>
        <tbody id="table-body"></tbody>
      </table>
      </div>
      <hr>

      <p align=center style="font-size: 30px;"><strong>Add New Wordle Entry</strong></p>

      <form id="entry-form" style="font-size: 30px;">
 
      <label for="the-date">Date:</label>
      <input type="text" id="the-date" maxlength="10" style="font-size: 30px; width: 170px" name="thedate" required>

      <label for="the-word">Word:</label>
      <input type="text" id="the-word" maxlength="5" style="font-size: 30px; width: 150px; text-transform:uppercase" name="theword" required>

      <label for="xchris">Chris:</label>
      <input type="number" maxlength="1" id="xchris" style="font-size: 30px; width: 60px;" name="chris" required>
      <label for="xjulia">Julia:</label>
      <input type="number" maxlength="1" id="xjulia" style="font-size: 30px; width: 60px;" name="julia" required>
      <label for="xnick">Nick:</label>
      <input type="number" maxlength="1" id="xnick" style="font-size: 30px; width: 60px;" name="nick" required>
      <br><br>
      <div style="text-align: center;">
        <button type="submit" style="font-size: 30px">Submit</button>
      </div>

    </form>
    <hr>
    <p align=center style="font-size: 30px;"><strong>Outright Wins</strong></p>
    <canvas id="wins-donut-chart" width="600" height="400"></canvas>
    <hr>
    <p align=center style="font-size: 30px;"><strong>Outright Losses</strong></p>
    <canvas id="losses-donut-chart" width="600" height="400"></canvas>
    <hr>
    <p align=center style="font-size: 30px;"><strong>Guess Distribution</strong></p>
    <canvas id="guesses-bar-chart" width="600" height="400"></canvas>
    <hr>
  

  </div>
    

  <script>

    let today = new Date();
 
    let dd = today.getDate();
    let mm = today.getMonth() + 1; // Months are zero-based
    let yyyy = today.getFullYear();

    dd = dd < 10 ? '0' + dd : dd;
    mm = mm < 10 ? '0' + mm : mm;

    let formattedDate = dd + '/' + mm + '/' + yyyy;

    document.getElementById('the-date').value = formattedDate;

    const entryForm = document.getElementById('entry-form');
    const tableBody = document.getElementById('table-body');
      
    const winDonutChartCtx = document.getElementById('wins-donut-chart').getContext('2d');
    const lossesDonutChartCtx = document.getElementById('losses-donut-chart').getContext('2d');
    const guessesBarChartCtx = document.getElementById('guesses-bar-chart').getContext('2d');
  
      //let prevTotal = 0;
    let winChart; // Holds Chart.js instance
    let lossesChart; // Holds Chart.js instance
    let guessesChart; // Holds Chart.js instance

    async function fetchDataAndUpdateUI() {
      const response = await fetch('https://sheetdb.io/api/v1/fxv69jnm5s4f6');
      const data = await response.json();

      tableBody.innerHTML = '';
      let indx = 0;
        
      let chrisWins = 0;
      let juliaWins = 0;
      let nickWins = 0;
      let noOneWins = 0;
        
      let chrisLosses = 0;
      let juliaLosses = 0;
      let nickLosses = 0;
      let noOneLosses = 0;
        
      let chrisBG;
      let juliaBG;
      let nickBG;

      let chrisGoes = [0,0,0,0,0,0,0];
      let juliaGoes = [0,0,0,0,0,0,0];
      let nickGoes = [0,0,0,0,0,0,0];
        
      data.forEach(myRow => {

        chrisGoes[myRow.Chris-1]++;
        juliaGoes[myRow.Julia-1]++;
        nickGoes[myRow.Nick-1]++;  

        chrisBG = "white";
        juliaBG = "white";
        nickBG = "white";
          
        if (myRow.Chris < myRow.Julia && myRow.Chris < myRow.Nick) {
          chrisBG = "lightgreen";
          chrisWins = chrisWins + 1;
        } else if (myRow.Julia < myRow.Chris && myRow.Julia < myRow.Nick) {
          juliaBG = "lightgreen";
          juliaWins = juliaWins + 1;
        } else if (myRow.Nick < myRow.Chris && myRow.Nick < myRow.Julia) {
          nickBG = "lightgreen";
          nickWins = nickWins + 1;
        } else {
          noOneWins = noOneWins + 1;
        }

        if (myRow.Chris > myRow.Julia && myRow.Chris > myRow.Nick) {
          chrisBG = "tomato";
          chrisLosses = chrisLosses + 1;
        } else if (myRow.Julia > myRow.Chris && myRow.Julia > myRow.Nick) {
          juliaBG = "tomato";
          juliaLosses = juliaLosses + 1;
        } else if (myRow.Nick > myRow.Chris && myRow.Nick > myRow.Julia) {
          nickBG = "tomato";
          nickLosses = nickLosses + 1;
        } else {
          noOneLosses = noOneLosses + 1;
        }

        //if (indx >= (data.length - 10)) {
          tableBody.innerHTML += `<tr><td align='right'>${myRow["TheDate"]}</td><td align='center'>${myRow["TheWord"]}</td><td align='center' style='background-color: ${chrisBG}'>${myRow["Chris"]}</td><td align='center' style='background-color: ${juliaBG}'>${myRow["Julia"]}</td><td align='center' style='background-color: ${nickBG}'>${myRow["Nick"]}</td></tr>`;
        //}
        indx = indx + 1;
      }); //data.forEach

        const container = document.getElementById('scrollTable');
  container.scrollTop = container.scrollHeight;

        
//console.log(chrisGoes, juliaGoes, nickGoes);
        
    //    console.log(chrisWins, juliaWins, nickWins, noOneWins, chrisLosses, juliaLosses, nickLosses, noOneLosses);
  // Prepare chart data
  //      const atEndOf = data.map(row => row["AtEndOf"]);
   //     const total = data.map(row => row["Total"]);

      const winData = {
        labels: [
          'Chris',
          'Julia',
          'Nick',
          'Draw'
        ], //labels
        datasets: [{
          label: 'Wins',
          data: [chrisWins, juliaWins, nickWins, noOneWins],
          backgroundColor: [
            'blue',
            'pink',
            'green',
            'grey'
          ], //backgroundColor
          hoverOffset: 4
        }] //datasets
      }; //winData

      const lossesData = {
        labels: [
          'Chris',
          'Julia',
          'Nick',
          'Draw'
        ], //labels
        datasets: [{
          label: 'Losses',
          data: [chrisLosses, juliaLosses, nickLosses, noOneLosses],
          backgroundColor: [
            'blue',
            'pink',
            'green',
            'grey'
          ], //backgroundColor
          hoverOffset: 4
        }] //datasets
      }; //lossesData
        
      if (winChart) {
        winChart.data.datasets[0].data[0] = chrisWins;
        winChart.data.datasets[0].data[1] = juliaWins;
        winChart.data.datasets[0].data[2] = nickWins;
        winChart.data.datasets[0].data[3] = noOneWins;
        winChart.update();
      } else {
        winChart = new Chart(winDonutChartCtx, {
          type: 'doughnut',
          data: winData,
          options: {
            plugins: {
              legend: {
                labels: {
                  font: {
                    size: 30
                  } //font
                } //labels
              }, //legend
    //          title: {
    //            display: true,
    //            text: "Outright Wins"
    //          }, //title
               tooltip: {
                titleFont: {
                  size: 30
              }, //titleFont
              bodyFont: {
                size: 30 // font size for tooltip body text
              }, //bodyFont
                footerFont: {
                  size: 30 // font size for tooltip footer text
                } //footerFont
              } //tooltip
            } //plugins
          } //options
        }); //new Chart
      } //if (winChart)

      if (lossesChart) {
        lossesChart.data.datasets[0].data[0] = chrisLosses;
        lossesChart.data.datasets[0].data[1] = juliaLosses;
        lossesChart.data.datasets[0].data[2] = nickLosses;
        lossesChart.data.datasets[0].data[3] = noOneLosses;
        lossesChart.update();
      } else {
        lossesChart = new Chart(lossesDonutChartCtx, {
          type: 'doughnut',
          data: lossesData,
          options: {
            plugins: {
              legend: {
                labels: {
                  font: {
                    size: 30
                  } //font
                } //labels
              }, //legend
    //          title: {
    //          display: true,
    //          text: "Outright Losses"
    //          }, //title
              tooltip: {
                titleFont: {
                  size: 30
                }, //titleFont
                bodyFont: {
                  size: 30
                }, //bodyFont
                footerFont: {
                  size: 30 // font size for tooltip footer text
                } //footerfont
              } //tooltip
            } //plugins
          } //options
        }); //new Chart

      } //if (lossesChart)
        
      const guessesData = {
        labels: ["Chris", "Julia", "Nick"],
        datasets: [{
          label: '1',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[0], juliaGoes[0], nickGoes[0]],
          backgroundColor: "blue"
        }, //set 1
        {
          label: '2',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[1], juliaGoes[1], nickGoes[1]],
          backgroundColor: "green"
        }, //set 2
        {
          label: '3',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[2], juliaGoes[2], nickGoes[2]],
          backgroundColor: "purple"
        }, //set 3
        {
          label: '4',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[3], juliaGoes[3], nickGoes[3]],
          backgroundColor: "yellow"
        }, //set 4
        {
          label: '5',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[4], juliaGoes[4], nickGoes[4]],
          backgroundColor: "orange"
        }, //set 5
        {
          label: '6',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[5], juliaGoes[5], nickGoes[5]],
          backgroundColor: "grey"
        }, //set 6
        {
          label: '7',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[6], juliaGoes[6], nickGoes[6]],
          backgroundColor: "salmon"
        }] //datasets
      }; //const guessesData

      const guessesConfig = {
//      type: "bar",
        data: guessesData,
        options: {
          plugins: {
//            title: {
//              display: true,
//              text: "Guess Distribution"
//            }, //title
            legend: {
              labels: {
                font: {
                  size: 30
                } //font
              } //labels
            }, //legend
                tooltip: {
                titleFont: {
                  size: 30
                }, //titleFont
                bodyFont: {
                  size: 30
                }, //bodyFont
                footerFont: {
                  size: 30 // font size for tooltip footer text
                } //footerfont
              } //tooltip
       }, //plugins
          responsive: true,
          scales: {
            x: {
              stacked: true,
              ticks: {
                font: {
                  size: 30 // Adjust this to change font size of labels below each bar
                }
              }
            },
            y: {
              stacked: true,
              ticks: {
                font: {
                  size: 30 // Adjust this to change font size of labels below each bar
                }
              }
            }
          } //scales
        } //options
      }; //const guessesConfig


      if (guessesChart) {
        guessesChart.data.datasets[0].data[0] = chrisGoes[0];
        guessesChart.data.datasets[0].data[1] = juliaGoes[0];
        guessesChart.data.datasets[0].data[2] = nickGoes[0];
        guessesChart.data.datasets[1].data[0] = chrisGoes[1];
        guessesChart.data.datasets[1].data[1] = juliaGoes[1];
        guessesChart.data.datasets[1].data[2] = nickGoes[1];
        guessesChart.data.datasets[2].data[0] = chrisGoes[2];
        guessesChart.data.datasets[2].data[1] = juliaGoes[2];
        guessesChart.data.datasets[2].data[2] = nickGoes[2];
        guessesChart.data.datasets[3].data[0] = chrisGoes[3];
        guessesChart.data.datasets[3].data[1] = juliaGoes[3];
        guessesChart.data.datasets[3].data[2] = nickGoes[3];
        guessesChart.data.datasets[4].data[0] = chrisGoes[4];
        guessesChart.data.datasets[4].data[1] = juliaGoes[4];
        guessesChart.data.datasets[4].data[2] = nickGoes[4];
        guessesChart.data.datasets[5].data[0] = chrisGoes[5];
        guessesChart.data.datasets[5].data[1] = juliaGoes[5];
        guessesChart.data.datasets[5].data[2] = nickGoes[5];
        guessesChart.data.datasets[6].data[0] = chrisGoes[6];
        guessesChart.data.datasets[6].data[1] = juliaGoes[6];
        guessesChart.data.datasets[6].data[2] = nickGoes[6];
        guessesChart.update();
      } else {
        guessesChart = new Chart(guessesBarChartCtx, guessesConfig); //new Chart            
      } //if (guessesChart)
        
      document.getElementById("everything").style.display = 'block';

    } //async function fetchDataAndUpdateUI
      
    entryForm.onsubmit = async (e) => {
      e.preventDefault();
      const TheDate = entryForm.thedate.value;
      const TheWord = entryForm.theword.value.toUpperCase();
      const Chris = entryForm.chris.value;
      const Julia = entryForm.julia.value;
      const Nick = entryForm.nick.value;

      await fetch('https://sheetdb.io/api/v1/fxv69jnm5s4f6', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([{ TheDate, TheWord, Chris, Julia, Nick }])
      }); //await fetch

      entryForm.reset();  // Clear form inputs
    
      fetchDataAndUpdateUI();  // Refresh table and chart
     
    }; //entryForm.onsubmit

// Initial data load
    fetchDataAndUpdateUI();
  
  </script>
    
</body>
  
</html>
