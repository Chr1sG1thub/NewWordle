<html>
  <head>
    <title>Wordle Results</title>
    <link rel="shortcut icon" type="image/png" href="wordlew.png"> 
    <style>
      * {font-family: Arial, sans-serif;
        }
 /*     table, td, th {
        border: 1px solid;
        padding: 10px;
      } */
    </style>
    <style>
      .table-container {
      height: 510px;              /* enough for ~10 rows */
      overflow-y: scroll;         /* vertical scrollbar */
      display: block;
      border: 1px solid #ccc;
      margin: auto;
      width: 75%;
      background-color: white;
      }
    </style>

    <style>
    .center-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .left-text {
      text-align: left;
      font-size: 36px;
      min-width: 250px; /* Optional: ensures visible width */
    }
  </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  </head>
  
  <body>
    
    <div id="nothing" style="display: block">
      <p align=center style="font-size: 36px;"><strong>Loading results. Please wait...</strong></p>   
    </div>
    
    <div id="everything" style="display: none">
      
      <p align=center style="font-size: 36px;"><strong>This Year's Results</strong></p>
      <p align=center style="font-size: 30px;"><i>Scroll panel to view</i></p>
     
      <table style="font-size: 36px; padding: 6px" align=center>
        <thead><tr><th align=center width=200px style="border: none">Date</th><th align=center width=150px style="border: none">Word</th><th align=center width=80px style="border: none">Chris</th><th align=center width=80px style="border: none">Julia</th><th align=center width=80px style="border: none">Nick</th></tr></thead>
      </table>
      
       <div class="table-container" id="scrollTable">

      <table style="font-size: 36px; padding: 6px" align=center>
        <tbody id="table-body"></tbody>
      </table>
      </div>
      <hr>

    <p align=center style="font-size: 36px;"><strong>Total Guesses</strong></p>

   <div class="center-container">
    <div class="left-text" id="totalGuesses">
    </div>
  </div>
     <hr>
    
    <p align=center style="font-size: 36px;"><strong>Outright Wins</strong></p>
    <canvas id="wins-donut-chart" width="600" height="400"></canvas>
    <hr>
    <p align=center style="font-size: 36px;"><strong>Outright Losses</strong></p>
    <canvas id="losses-donut-chart" width="600" height="400"></canvas>
    <hr>
    <p align=center style="font-size: 36px;"><strong>Guess Distribution</strong></p>
    <canvas id="guesses-bar-chart" width="600" height="800"></canvas>
    <hr>
      <p align=center style="font-size: 36px;"><strong>Add New Wordle Entry</strong></p>

      <form id="entry-form" style="font-size: 30px;">
 
      <label for="the-date">Date:</label>
      <input type="text" id="the-date" maxlength="10" style="font-size: 30px; width: 170px" name="thedate" required>

      <label for="the-word">Word:</label>
      <input type="text" id="the-word" maxlength="5" style="font-size: 30px; width: 150px; text-transform:uppercase" name="theword" required>

      <label for="xchris">Chris:</label>
      <input type="number" maxlength="1" id="xchris" style="font-size: 30px; width: 60px;" name="chris" required>
      <label for="xjulia">Julia:</label>
      <input type="number" maxlength="1" id="xjulia" style="font-size: 30px; width: 60px;" name="julia" required>
      <label for="xnick">Nick:</label>
      <input type="number" maxlength="1" id="xnick" style="font-size: 30px; width: 60px;" name="nick" required>
      <br><br>
      <div style="text-align: center;">
        <button type="submit" style="font-size: 36px">Submit</button>
      </div>

    </form>
    <hr>
  

  </div>
    

  <script>

Chart.register(ChartDataLabels);
    
    let today = new Date();
 
    let dd = today.getDate();
    let mm = today.getMonth() + 1; // Months are zero-based
    let yyyy = today.getFullYear();

    dd = dd < 10 ? '0' + dd : dd;
    mm = mm < 10 ? '0' + mm : mm;

    let formattedDate = dd + '/' + mm + '/' + yyyy;

    document.getElementById('the-date').value = formattedDate;

    const entryForm = document.getElementById('entry-form');
    const tableBody = document.getElementById('table-body');
      
    const winDonutChartCtx = document.getElementById('wins-donut-chart').getContext('2d');
    const lossesDonutChartCtx = document.getElementById('losses-donut-chart').getContext('2d');
    const guessesBarChartCtx = document.getElementById('guesses-bar-chart').getContext('2d');
  
      //let prevTotal = 0;
    let winChart; // Holds Chart.js instance
    let lossesChart; // Holds Chart.js instance
    let guessesChart; // Holds Chart.js instance

    async function fetchDataAndUpdateUI() {
      const response = await fetch('https://script.google.com/macros/s/AKfycbyiWq3PC6545nqvqUkyD21239obLoJn2O-gvFsa3pZ0EOXoPEKI3HUDfJcAiqjSauPj/exec');
      const data = await response.json();

      tableBody.innerHTML = '';
      let indx = 0;
        
      let chrisWins = 0;
      let juliaWins = 0;
      let nickWins = 0;
      let noOneWins = 0;
        
      let chrisLosses = 0;
      let juliaLosses = 0;
      let nickLosses = 0;
      let noOneLosses = 0;
        
      let chrisBG;
      let juliaBG;
      let nickBG;

      let chrisCount = 0;
      let juliaCount = 0;
      let nickCount = 0;
      
      let chrisGoes = [0,0,0,0,0,0,0];
      let juliaGoes = [0,0,0,0,0,0,0];
      let nickGoes = [0,0,0,0,0,0,0];
        
      data.forEach(myRow => {

        chrisCount = chrisCount + myRow.Chris;
        juliaCount = juliaCount + myRow.Julia;
        nickCount = nickCount + myRow.Nick;

        chrisGoes[myRow.Chris-1]++;
        juliaGoes[myRow.Julia-1]++;
        nickGoes[myRow.Nick-1]++;  

        chrisBG = "white";
        juliaBG = "white";
        nickBG = "white";
          
        if (myRow.Chris < myRow.Julia && myRow.Chris < myRow.Nick) {
          chrisBG = "lightgreen";
          chrisWins = chrisWins + 1;
        } else if (myRow.Julia < myRow.Chris && myRow.Julia < myRow.Nick) {
          juliaBG = "lightgreen";
          juliaWins = juliaWins + 1;
        } else if (myRow.Nick < myRow.Chris && myRow.Nick < myRow.Julia) {
          nickBG = "lightgreen";
          nickWins = nickWins + 1;
        } else {
          noOneWins = noOneWins + 1;
        }

        if (myRow.Chris > myRow.Julia && myRow.Chris > myRow.Nick) {
          chrisBG = "lightpink";
          chrisLosses = chrisLosses + 1;
        } else if (myRow.Julia > myRow.Chris && myRow.Julia > myRow.Nick) {
          juliaBG = "lightpink";
          juliaLosses = juliaLosses + 1;
        } else if (myRow.Nick > myRow.Chris && myRow.Nick > myRow.Julia) {
          nickBG = "lightpink";
          nickLosses = nickLosses + 1;
        } else {
          noOneLosses = noOneLosses + 1;
        }

        //if (indx >= (data.length - 10)) {
          tableBody.innerHTML += `<tr><td  width=200px style="border: none" align='center'>${myRow["TheDate"]}</td><td width=150px style="border: none" align='center'>${myRow["TheWord"]}</td><td width=80px align='center' style='border: none; background-color: ${chrisBG}'>${myRow["Chris"]}</td><td width=80px align='center' style='border: none; background-color: ${juliaBG}'>${myRow["Julia"]}</td><td width=80px align='center' style='border: none; background-color: ${nickBG}'>${myRow["Nick"]}</td></tr>`;
        //}
        indx = indx + 1;
      }); //data.forEach
      
//      console.log (chrisCount, juliaCount, nickCount);
      
    const totalGuesses = document.getElementById('totalGuesses');
      let chrisJulia = chrisCount - juliaCount;
      let chrisNick  = chrisCount - nickCount;
      let juliaChris = juliaCount - chrisCount;
      let juliaNick  = juliaCount - nickCount;
      let nickChris  = nickCount  - chrisCount;
      let nickJulia  = nickCount  - juliaCount;
      let chrisJuliaText;
      let chrisNickText;
      let juliaChrisText;
      let juliaNickText;
      let nickChrisText;
      let nickJuliaText;

      if (chrisJulia == 0) {
        chrisJuliaText = 'the same as <strong>Julia</strong>';
      } else if (chrisJulia < 0) {
        chrisJuliaText = (-chrisJulia)+' better than <strong>Julia</strong>';
      } else {
        chrisJuliaText = (chrisJulia)+' worse than <strong>Julia</strong>';
      }

      if (chrisNick == 0) {
        chrisNickText = 'the same as <strong>Nick</strong>';
      } else if (chrisNick < 0) {
        chrisNickText = (-chrisNick)+' better than <strong>Nick</strong>';
      } else {
        chrisNickText = (chrisNick)+' worse than <strong>Nick</strong>';
      }

      if (juliaChris == 0) {
        juliaChrisText = 'the same as <strong>Chris</strong>';
      } else if (juliaChris < 0) {
        juliaChrisText = (-juliaChris)+' better than <strong>Chris</strong>';
      } else {
        juliaChrisText = (juliaChris)+' worse than <strong>Chris</strong>';
      }

      if (juliaNick == 0) {
        juliaNickText = 'the same as <strong>Nick</strong>';
      } else if (juliaNick < 0) {
        juliaNickText = (-juliaNick)+' better than <strong>Nick</strong>';
      } else {
        juliaNickText = (juliaNick)+' worse than <strong>Nick</strong>';
      }

      if (nickChris == 0) {
        nickChrisText = 'the same as <strong>Chris</strong>';
      } else if (nickChris < 0) {
        nickChrisText = (-nickChris)+' better than <strong>Chris</strong>';
      } else {
        nickChrisText = (nickChris)+' worse than <strong>Chris</strong>';
      }

      if (nickJulia == 0) {
        nickJuliaText = 'the same as <strong>Julia</strong>';
      } else if (nickJulia < 0) {
        nickJuliaText = (-nickJulia)+' better than <strong>Julia</strong>';
      } else {
        nickJuliaText = (nickJulia)+' worse than <strong>Julia</strong>';
      }

      totalGuesses.innerHTML = `<strong>Chris</strong> has made ${chrisCount} guesses, ${chrisJuliaText}, ${chrisNickText}.<br/><br/><strong>Julia</strong> has made ${juliaCount} guesses, ${juliaChrisText}, ${juliaNickText}<br/><br/><strong>Nick</strong> has made ${nickCount} guesses, ${nickChrisText}, ${nickJuliaText}.`;
      
       // const container = document.getElementById('scrollTable');
      
  //container.scrollTop = container.scrollHeight;

        
//console.log(chrisGoes, juliaGoes, nickGoes);
        
    //    console.log(chrisWins, juliaWins, nickWins, noOneWins, chrisLosses, juliaLosses, nickLosses, noOneLosses);
  // Prepare chart data
  //      const atEndOf = data.map(row => row["AtEndOf"]);
   //     const total = data.map(row => row["Total"]);

      const winData = {
        labels: [
          'Chris',
          'Julia',
          'Nick',
          'Draw'
        ], //labels
        datasets: [{
          label: 'Wins',
          data: [chrisWins, juliaWins, nickWins, noOneWins],
          backgroundColor: [
            'lightblue',
            'lightpink',
            'lightgreen',
            'lemonchiffon'
          ], //backgroundColor
          hoverOffset: 4
        }] //datasets
      }; //winData

      const lossesData = {
        labels: [
          'Chris',
          'Julia',
          'Nick',
          'Draw'
        ], //labels
        datasets: [{
          label: 'Losses',
          data: [chrisLosses, juliaLosses, nickLosses, noOneLosses],
          backgroundColor: [
            'lightblue',
            'lightpink',
            'lightgreen',
            'lemonchiffon'
          ], //backgroundColor
          hoverOffset: 4
        }] //datasets
      }; //lossesData
        
      if (winChart) {
        winChart.data.datasets[0].data[0] = chrisWins;
        winChart.data.datasets[0].data[1] = juliaWins;
        winChart.data.datasets[0].data[2] = nickWins;
        winChart.data.datasets[0].data[3] = noOneWins;
        winChart.update();
      } else {
        winChart = new Chart(winDonutChartCtx, {
          type: 'doughnut',
          data: winData,
          options: {
            plugins: {
    datalabels: {
      anchor: 'center',      // position of label relative to bar segment
      align: 'center',       // alignment of label inside segment
  //    color: 'white',        // label color
      font: {
    //    weight: 'bold',
        size: 30
      },
       formatter: (value, ctx) => {
          const label = ctx.chart.data.labels[ctx.dataIndex];
          return label + ': ' + value;
        }
      }, //datalabels
            legend: {
              display: false,
                labels: {
                  enabled: false
   //               font: {
    //                size: 30
    //              }, //font
                } //labels
              }, //legend
    //          title: {
    //            display: true,
    //            text: "Outright Wins"
    //          }, //title
               tooltip: {
                 enabled: false
          } //tooltip
               } //plugins
          } //options
        }); //new Chart
      } //if (winChart)

      if (lossesChart) {
        lossesChart.data.datasets[0].data[0] = chrisLosses;
        lossesChart.data.datasets[0].data[1] = juliaLosses;
        lossesChart.data.datasets[0].data[2] = nickLosses;
        lossesChart.data.datasets[0].data[3] = noOneLosses;
        lossesChart.update();
      } else {
        lossesChart = new Chart(lossesDonutChartCtx, {
          type: 'doughnut',
          data: lossesData,
          options: {
            plugins: {
  datalabels: {
      anchor: 'center',      // position of label relative to bar segment
      align: 'center',       // alignment of label inside segment
  //    color: 'white',        // label color
      font: {
      //  weight: 'bold',
        size: 30
      },
       formatter: (value, ctx) => {
          const label = ctx.chart.data.labels[ctx.dataIndex];
          return label + ': ' + value;
         //  return value;
        }
      }, //datalabels
              legend: {
                display: false,
                labels: {
                  enabled: false
   //               font: {
    //                size: 30
    //              }, //font
                } //labels
             }, //legend
    //          title: {
    //          display: true,
    //          text: "Outright Losses"
    //          }, //title
               tooltip: {
                 enabled: false
          } //tooltip
            } //plugins
          } //options
        }); //new Chart

      } //if (lossesChart)
        
      const guessesData = {
        labels: ["Chris", "Julia", "Nick"],
        datasets: [{
          label: '1',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[0], juliaGoes[0], nickGoes[0]],
          backgroundColor: "#FFD1DC"
        }, //set 1
        {
          label: '2',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[1], juliaGoes[1], nickGoes[1]],
          backgroundColor: "#A7C7E7"
        }, //set 2
        {
          label: '3',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[2], juliaGoes[2], nickGoes[2]],
          backgroundColor: "#AAF0D1"
        }, //set 3
        {
          label: '4',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[3], juliaGoes[3], nickGoes[3]],
          backgroundColor: "#FFE5B4"
        }, //set 4
        {
          label: '5',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[4], juliaGoes[4], nickGoes[4]],
          backgroundColor: "#E3E4FA"
        }, //set 5
        {
          label: '6',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[5], juliaGoes[5], nickGoes[5]],
          backgroundColor: "#FFFACD"
        }, //set 6
        {
          label: '7',
          type: 'bar',
          stack: 'combined',
          data: [chrisGoes[6], juliaGoes[6], nickGoes[6]],
          backgroundColor: "#F6C1B2"
        }] //datasets
      }; //const guessesData

      const guessesConfig = {
//      type: "bar",
        data: guessesData,
        options: {
          plugins: {
 
//            title: {
//              display: true,
//              text: "Guess Distribution"
//            }, //title
  datalabels: {
      anchor: 'center',      // position of label relative to bar segment
      align: 'center',       // alignment of label inside segment
  //    color: 'white',        // label color
      font: {
      //  weight: 'bold',
        size: 30
      },
       formatter: (value, ctx) => {
         if (value == 0) return null;
          const label = ctx.dataset.label;
         if (label == "7") return 'Fails: ' + value;
         if (label == "1") return label + ' guess: ' + value;
          return label + ' guesses: ' + value;
    //      return value;
        }
     }, //datalabels
    //     return value;        // show the segment value
   //   }
 //  },
            legend: {
              display: false,
                labels: {
                  enabled: false
   //               font: {
    //                size: 30
    //              }, //font
    //            }, //labels
  //             labels: {
  //             font: {
   //               size: 30
    //            }, //font
   //       generateLabels: function(chart) {
    //        const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
     //       original.forEach(label => {
    //          if (label.text === '7') {
    //            label.text = 'Fail'; // change "7" to "Fail"
    //         }
     //       });
     //       return original;
        //  }
              } //labels
            }, //legend
               tooltip: {
                 enabled: false
   //             titleFont: {
   //               size: 30
   //           }, //titleFont
   //           bodyFont: {
   //             size: 30 // font size for tooltip body text
   //           }, //bodyFont
   //             footerFont: {
   //               size: 30 // font size for tooltip footer text
   //             } //footerFont
              } //tooltip
       }, //plugins
          responsive: true,
          scales: {
            x: {
              stacked: true,
              ticks: {
                font: {
                  size: 30 // Adjust this to change font size of labels below each bar
                }
              }
            },
            y: {
              stacked: true,
              ticks: {
                font: {
                  size: 30 // Adjust this to change font size of labels below each bar
                }
              }
            }
          } //scales
        } //options
      }; //const guessesConfig


      if (guessesChart) {
        guessesChart.data.datasets[0].data[0] = chrisGoes[0];
        guessesChart.data.datasets[0].data[1] = juliaGoes[0];
        guessesChart.data.datasets[0].data[2] = nickGoes[0];
        guessesChart.data.datasets[1].data[0] = chrisGoes[1];
        guessesChart.data.datasets[1].data[1] = juliaGoes[1];
        guessesChart.data.datasets[1].data[2] = nickGoes[1];
        guessesChart.data.datasets[2].data[0] = chrisGoes[2];
        guessesChart.data.datasets[2].data[1] = juliaGoes[2];
        guessesChart.data.datasets[2].data[2] = nickGoes[2];
        guessesChart.data.datasets[3].data[0] = chrisGoes[3];
        guessesChart.data.datasets[3].data[1] = juliaGoes[3];
        guessesChart.data.datasets[3].data[2] = nickGoes[3];
        guessesChart.data.datasets[4].data[0] = chrisGoes[4];
        guessesChart.data.datasets[4].data[1] = juliaGoes[4];
        guessesChart.data.datasets[4].data[2] = nickGoes[4];
        guessesChart.data.datasets[5].data[0] = chrisGoes[5];
        guessesChart.data.datasets[5].data[1] = juliaGoes[5];
        guessesChart.data.datasets[5].data[2] = nickGoes[5];
        guessesChart.data.datasets[6].data[0] = chrisGoes[6];
        guessesChart.data.datasets[6].data[1] = juliaGoes[6];
        guessesChart.data.datasets[6].data[2] = nickGoes[6];
        guessesChart.update();
      } else {
        guessesChart = new Chart(guessesBarChartCtx, guessesConfig); //new Chart            
      } //if (guessesChart)
        
      document.getElementById("nothing").style.display = 'none';
      document.getElementById("everything").style.display = 'block';
 
      const container = document.getElementById('scrollTable');
      container.scrollTop = container.scrollHeight;

    } //async function fetchDataAndUpdateUI
      
    entryForm.onsubmit = async (e) => {
      e.preventDefault();
      const TheDate = entryForm.thedate.value;
      const TheWord = entryForm.theword.value.toUpperCase();
      const Chris = entryForm.chris.value;
      const Julia = entryForm.julia.value;
      const Nick = entryForm.nick.value;

      await fetch('https://sheetdb.io/api/v1/fxv69jnm5s4f6', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([{ TheDate, TheWord, Chris, Julia, Nick }])
      }); //await fetch

      entryForm.reset();  // Clear form inputs
    
      fetchDataAndUpdateUI();  // Refresh table and chart
     
    }; //entryForm.onsubmit

// Initial data load
    fetchDataAndUpdateUI();
  
  </script>
    
</body>
  
</html>
